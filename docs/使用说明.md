# 志愿者排表系统使用说明

## 快速开始

### 1. 系统安装

```bash
# 克隆或下载项目到本地
cd Bot

# 安装依赖
pip install -r requirements.txt

# 或者使用 Makefile
make install
```

### 2. 初始化项目

```bash
# 创建必要的目录结构
make setup

# 或者运行
python main.py --check
```

### 3. 准备输入文件

将以下文件放入 `input/` 目录：

- `普通志愿者招募表.xlsx` - 通过问卷收集的志愿者报名信息
- `内部志愿者表.xlsx` - 组织内部志愿者名单
- `家属志愿者表.xlsx` - 内部志愿者家属名单
- `情侣志愿者表.xlsx` - 情侣志愿者报名信息
- `岗位表.xlsx` - 活动主办方提供的岗位需求
- `直接委派名单.xlsx` - 需要直接分配的志愿者名单

将以下文件放入相应目录：

- `input/团体/` - 各团体志愿者文件（如：计算机学院团委.xlsx）
- `input/面试打分表/` - 各面试官的打分表文件

### 4. 运行系统

```bash
# 运行完整流程
python main.py --all

# 或者使用 Makefile
make run-all

# 或者分步运行
make run-interview  # 先处理面试结果
make run-scheduling # 再进行排表
```

## 详细使用指南

### 模块说明

#### 1. 通用工具模块 (`src/utils/`)

这些工具可以独立使用，也可以被其他模块调用：

- **merger.py** - 合并多个Excel文件
- **sorter.py** - 对Excel文件进行排序
- **extractor.py** - 提取或排除指定列
- **deduplicator.py** - 去除重复记录
- **splitter.py** - 根据指定列拆分文件
- **comparator.py** - 对比两个表格并拆分
- **joiner.py** - 合并表格并插入字段
- **checker.py** - 多表格查重

使用示例：
```bash
# 合并多个面试打分表
python src/utils/merger.py input/面试打分表/*.xlsx -o output/合并打分表.xlsx

# 按归一化成绩排序
python src/utils/sorter.py output/合并打分表.xlsx -o output/排序打分表.xlsx -c 归一化成绩

# 提取指定列
python src/utils/extractor.py output/排序打分表.xlsx -o output/提取字段.xlsx -c 姓名 学号 归一化成绩
```

#### 2. 面试结果收集模块 (`src/interview/`)

- **summarizer.py** - 汇总面试打分表
- **separator.py** - 分离已面试和未面试人员

使用示例：
```bash
# 汇总面试打分表
python src/interview/summarizer.py -i input/面试打分表 -o pipeline/01_interview_results/统一面试打分表.xlsx

# 分离已面试和未面试人员
python src/interview/separator.py -r input/普通志愿者招募表.xlsx -i pipeline/01_interview_results/统一面试打分表.xlsx -o-interviewed pipeline/01_interview_results/普通志愿者表.xlsx -o-un pipeline/01_interview_results/未面试人员名单.xlsx
```

#### 3. 排表模块 (`src/scheduling/`)

核心排表逻辑（正在开发中）：

- **data_models.py** - 数据模型定义
- **pre_checker.py** - 基本信息核查和收集
- **splitter.py** - 正式普通志愿者和储备志愿者拆分
- **family_checker.py** - 家属志愿者资格审查
- **couple_checker.py** - 情侣志愿者资格核查
- **group_allocator.py** - 小组划分及组长分配
- **binder.py** - 绑定集合生成
- **main_scheduler.py** - 排表主程序
- **finalizer.py** - 最终处理程序

### 配置文件说明

系统配置通过 `config/config.yaml` 文件管理：

- **路径配置** - 输入输出目录、文件路径等
- **字段映射** - 各种字段的关键词映射
- **系统设置** - 算法参数、限制条件等
- **颜色配置** - Excel背景色设置
- **日志配置** - 日志级别和格式

修改配置后无需重启，系统会自动重新加载。

### 输入文件格式要求

#### 通用字段（所有志愿者表都包含）

- 学号、姓名、姓名拼音、性别
- 证件类型、证件号、出生日期
- 学院、身高、邮箱、手机号
- QQ号、微信号、政治面貌
- 第几次做马拉松志愿者、校区、宿舍楼栋、衣服尺码

#### 特殊字段

**普通志愿者招募表**：
- 其他工作（摄影志愿者、小闪电、无）

**内部志愿者表**：
- 是否以小组长或者区长的身份参加本次活动

**家属志愿者表**：
- 你是谁的家属
- 活动中是否希望与他/她同组

**面试打分表**：
- 姓名、学号
- 归一化成绩、闪电得分、摄影得分
**岗位表**：
- 岗位名称、岗位简介、需求人数

### 输出文件说明

#### 主要输出文件

- `总表.xlsx` - 最终的排班总表，包含所有志愿者的分配信息
- `大总表.xlsx` - 整合了多个相关表格的Excel文件（多sheet）
- `各小组名单/` - 按小组拆分的名单文件

#### 中间文件

- `pipeline/01_interview_results/` - 面试结果收集模块输出
- `pipeline/02_scheduling_preparation/` - 排表准备阶段输出

#### 报告文件

- `reports/` - 各种核查报告和统计报告

### 故障排除

#### 常见问题

1. **文件不存在错误**
   - 确保所有输入文件都放在正确的目录中
   - 检查文件名是否与配置文件中的设置一致

2. **列名匹配失败**
   - 系统使用关键词匹配列名，确保表头包含相应的关键词
   - 可以在 `config.yaml` 中修改字段映射配置

3. **编码问题**
   - 确保Excel文件使用UTF-8编码保存
   - 避免在文件名和列名中使用特殊字符

4. **内存不足**
   - 对于大文件，系统会自动分块处理
   - 可以调整 `config.yaml` 中的 `chunk_size` 参数

#### 日志查看

所有操作都会记录日志：
- 主日志：`logs/`
- 模块日志：`logs/utils/`、`logs/interview/`、`logs/scheduling/`

#### 调试模式

```bash
# 启用详细输出
python main.py --all --verbose

# 查看系统信息
python main.py --info

# 检查前提条件
python main.py --check
```

### 开发者指南

#### 项目结构

```
Bot/
├── src/                    # 源代码
│   ├── utils/             # 通用工具模块
│   ├── interview/         # 面试结果收集模块
│   └── scheduling/        # 排表模块
├── config/                # 配置文件
├── input/                 # 输入数据
├── pipeline/              # 中间数据
├── output/                # 输出结果
├── reports/               # 报告文件
├── logs/                  # 日志文件
└── main.py               # 主控程序
```

#### 扩展开发

1. **添加新的通用工具**
   - 在 `src/utils/` 中创建新的Python文件
   - 继承 `ExcelHandler` 类的功能
   - 添加命令行接口

2. **修改排表算法**
   - 主要逻辑在 `src/scheduling/main_scheduler.py`
   - 数据模型在 `src/scheduling/data_models.py`
   - 配置参数在 `config/config.yaml`

3. **自定义配置**
   - 修改 `config/config.yaml` 文件
   - 在 `config/loader.py` 中添加新的配置获取方法

#### 测试

```bash
# 运行测试
make test

# 代码质量检查
make check

# 代码格式化
make format-code
```

### 联系支持

如果遇到问题或需要帮助：

1. 查看 `reports/` 目录中的报告文件
2. 检查 `logs/` 目录中的日志文件
3. 参考 `README.md` 中的详细说明
4. 运行 `python main.py --info` 查看系统状态

---

**注意**：本系统正在开发中，部分功能可能还不完善。建议在使用前先备份数据，并在小规模数据上测试。