# 排表主程序详细步骤讲解

## 基本信息

这个程序是排表模块的核心程序，负责将所有志愿者分配到各个小组中，生成最终的排班总表。这里需要实现前面“排表规则”部分中提到的各个环节和规则，确保排表过程合理且符合要求。

- 输入：小组信息表Excel文件、绑定集合表Excel文件、正式普通志愿者表Excel文件、内部志愿者表Excel文件、家属志愿者表Excel文件、所有团体志愿者表Excel文件、metadata.json文件、直接委派名单Excel文件。
- 输出：总表Excel文件。
- 功能：根据岗位需求和志愿者的属性，将志愿者分配到各个小组中，生成最终的排班总表。确保所有岗位的需求人数都被满足，且所有绑定关系都被满足。总表中会包含每个志愿者的基本信息和所属小组信息，并根据志愿者的属性和身份的不同，设置不同的背景颜色。

> 设置背景颜色要遵循优先级规则，大体上原则是“身份 > 属性”。即在设置背景颜色时要先考虑志愿者的身份（组长、小闪电、摄影、情侣，只有这四种），如果没有任何身份，则再考虑属性（内部志愿者、家属志愿者、团体志愿者）。如果一个志愿者同时具有多种身份，则按照优先级最高的身份来设置背景颜色。优先级顺序为：组长 > 小闪电 > 摄影 > 情侣 。比如某个志愿者的属性是“家属志愿者”，但他同时拥有情侣和小闪电的身份，那么他最终的背景颜色应该是小闪电的颜色，因为小闪电的优先级高于情侣和家属志愿者。

## 步骤
1. 首先，创建出一个空的Excel表格，这其实就是最后“总表.xlsx”的雏形。
   - 总表的表头字段按顺序分别是“小组号、岗位名称、岗位简介、小组长、学号、姓名、姓名拼音、性别、证件类型、证件号、出生日期、学院、身高、邮件、手机号、QQ号、微信号、证件面貌、马拉松次数、校区、宿舍楼栋、衣服尺码”。
   - 其中前四列是小组相关的信息，后面的字段是志愿者的基本信息。每一行数据代表一个志愿者的排班信息。且根据志愿者的属性和身份的不同，属于他的那一行表格数据的背景颜色也会不同。

   可以先把第一行的表头填充好（其中“小组长”指的是小组长的姓名）。


2. 读取“小组信息表.xlsx”，根据表中的内容搭建并填充好总表的框架
   - 先把总表的前四列（“小组号、岗位名称、岗位简介、小组长”）填充完整：这四列内容可从小组信息表中识别并读取。
| 岗位名称 | 岗位简介 | 小组号 | 组长姓名 | 组长学号 | 组长手机号 | 小组人数 |
| --- | --- | ---: | --- | --- | --- | ---: |
| 5KM补给站 | 饮料站 | 1 | 陈畅雨 | 524031910586 | 19288212365 | 42 |
| 5KM补给站 | 饮料站 | 2 | 曾庆旅 | 524031910526 | 19207802948 | 42 |
| 5KM补给站 | 饮料站 | 3 | 周启泰 | 524031910394 | 18930448307 | 42 |
| 5KM补给站 | 饮料站 | 4 | 李凡 | 524031910547 | 19507058553 | 41 |
| 5KM补给站 | 饮料站 | 5 | 罗义博 | 523051910024 | 13510756469 | 41 |
| 10KM补给站 | 饮料站 | 6 | 栾皓雄 | 523031910650 | 13081637618 | 36 |
    小组信息表的格式和上面保持一致，就以上面这个表格为例，我们先看每一个小组的人数，比如第一个小组人数是42，所以表格的2~43行的前四列内容都是一样的，都是“1，5KM补给站，饮料站，陈畅雨”；紧接着的下面的42行都填充成第2组的内容；以此类推。

    经过这一系列操作，除了第一行表头，已经有填充了总表所有行数的前四列内容。如果一共有800个岗位需求人数，那么总表就一共有801行。但是现在后面的列还都是空值，需要往里面填充志愿者信息（学号、姓名、姓名拼音、性别、证件类型、证件号、出生日期、学院、身高、邮件、手机号、QQ号、微信号、证件面貌、马拉松次数、校区、宿舍楼栋、衣服尺码）。

    至此，整个总表.xlsx的大致框架已经搭好。

> 在这一步可以构建一个表示各小组元信息的数组结构，方便后续分配志愿者时方便。可以是一个数组，数组中的每个元素都是一个表示小组元信息的结构体，包含但不限于:`组长学号`，`小组人数`，`小组剩余容量`，`是否有“小闪电”`，`是否有摄影志愿者`。（这里不用填加小组号的信息，因为数组的索引+1就是小组号，比如某个小组元信息在这个数组中的索引是0，那表明这个小组的组号就是1）初始化时，`组长学号`和`小组人数`都可以从小组信息表中获取，`小组剩余容量`的初始等于`小组人数`，`是否有“小闪电”`和`是否有摄影志愿者`这两个值都设为false。

1. 构建不同的志愿者池和数据结构
   - 分别读取正式普通志愿者表、内部志愿者表、家属志愿者表、所有的团体志愿者表，按道理说这些表格的并集人数正好是总表的行数。 分别构建`正式普通志愿者池`、`内部志愿者池`、`家属志愿者池`、`团体志愿者池`。这个“池”的结构可以是map结构，键是每个志愿者的学号，值是志愿者对象这个数据结构。之后可以通过键值快速操控志愿者对象。
   - 读取表格的每一行都是一个志愿者的基本信息，每一行数据都可以构造一个志愿者对象，该对象的基本属性对应总表剩下的需要填充的字段（学号、姓名、姓名拼音、性别、证件类型、证件号、出生日期、学院、身高、邮件、手机号、QQ号、微信号、证件面貌、马拉松次数、校区、宿舍楼栋、衣服尺码）。除了这些基本属性之外，可能还有一些代表志愿者属性和身份的属性值。最好还有一个颜色属性，是根据志愿者的身份和属性，结合优先级规则和配置文件赋值的。
    > 但是这里有关于“宿舍楼栋”的赋值可能还需要额外的操作：各大志愿者表格中有关于“宿舍楼栋”的信息有两列，分别是“宿舍楼栋（闵行）”和“宿舍楼栋（非闵行）”，但是总表中是有“宿舍楼栋”这一个字段，志愿者对象中有关于“宿舍楼栋”的属性也只有一个，所以这里需要先检查“宿舍楼栋（闵行）”，如果这个值不为空，那么直接将“宿舍楼栋”赋值成“宿舍楼栋（闵行）”的值；如果这个值是空的，那么“宿舍楼栋（非闵行）”一定不为空，将“宿舍楼栋”赋值成“宿舍楼栋（非闵行）”的值
   - 读取情侣志愿者表，利用学号在各志愿者池中找到相应的志愿者对象，给他们赋上情侣志愿者的身份。
   - 读取绑定集合表，构造绑定集合相应的数据结构。
   - 读取直接委派名单表，构造相应的数据结构。

2. 分配并插入志愿者数据
   
分配的总体思路是利用`学号`这个主键在各个志愿者池中寻找，找到志愿者数据后，将志愿者的学号插入到`已分配人员学号的集合`，从相应志愿者池中删除，并把志愿者信息插入到总表的指定位置中，并根据他的身份和属性为这一行填充相应的背景颜色。如果在插入`已分配人员学号的集合`时发现已经存在，则需要从相应志愿者池中删除掉这个志愿者数据。

实际上就是想让代码模拟人工排表时的步骤。

> 这里有几个原则：
> * 正式普通志愿者池、内部志愿者池、家属志愿者池、团体志愿者池、已分配人员中对应的志愿者没有重合，且始终满足下面一个等式：岗位需求总人数 = 正式普通志愿者池元素数量+内部志愿者池元素数量+家属志愿者池元素数量+团体志愿者池元素数量+已分配人员学号集合元素数量。
> 颜色、路径、字段等需要结合配置文件，多利用配置文件，尽量做到解耦，之后哪怕做更改也只是改动配置文件就好，不用改动代码逻辑

具体步骤：

   - 先构建一个初始为空的已分配人员学号的集合，每分配一个人，他的学号就插入到这个集合中；每当要将一个人插入到总表中时，都要先查询一下学号是不是在这个集合中，如果已存在，证明之前已经分配过这个人了，不用再分配了。
   - 在总表中每个小组的第一行先插入组长的相关信息。
   - 再检查小组长是否存在于某个绑定集合中，如果在，则紧接着将这个绑定集合中的其他志愿者插入到这个小组长的下面。
   - 依次检查剩下的绑定集合，先处理有直接分配任务的绑定集合，将绑定集合中的元素从相应的志愿者池中找到，并插入到同一指定小组。剩下的绑定集合就是自由分配了，要遵循“大集合优先插入空位多的小组”的原则进行分配。
   > 这一步完成之后，所有的团体志愿者和家属志愿者应该就分配完了，换句话说，团体志愿者池和家属志愿者池应该已经空了
   - 读取直接委派名单，依次检查每个有直接委派任务的人是不是已经出现在了`已分配人员学号的集合`中，如果在，证明在前序步骤中已经给他成功分配过了，直接跳过就好，再接着处理下一个；如果不在，就从各志愿者池中寻找对应的志愿者对象，并将相应的数据插入到总表指定位置，并更新所有数据结构。
   > 这一步完成之后，应该只有正式普通志愿者池和内部志愿者池中有剩余元素，其他两个池应该都已经空了，且剩下的应该都是没有直接委派任务的落单志愿者。
   - 为每个组分配“小闪电”和摄影志愿者：读取统一面试打分表，重点关注“闪电得分”和“摄影得分”这两列，可以构建两个合适的数据结构，将得分大于0的志愿者信息（学号）插入到相应集合中，并按照得分大小降序排列。分配“小闪电”和摄影志愿者的逻辑是一样的，所以我就以分配“小闪电”为例。我们先取出“小闪电”集合中得分最高的人的学号，去志愿者池中寻找相应的志愿者对象（因为“小闪电”和摄影志愿者只从正式普通志愿者中产生，所以只用在正式普通志愿者池中查找就好），如果没有找到，那么这个人就无法成为小闪电，直接将该学号从小闪电集合中删除，继续取出得分最高的人重复上述操作。如果学号在`志愿者池`中能找到相应的对象，那么这个志愿者对象将被正式赋予小闪电的身份，并将该志愿者数据随机插入到某个还没有小闪电的小组中，插入总表成功后就可以把他从小闪电集合中删除了，继续取出得分最高的人重复上述操作，直到所有小组都成功拥有了小闪电。
   > 分配摄影志愿者的逻辑和小闪电完全一致

   - 将`正式普通志愿者池`和`内部志愿者池`中的剩余落单元素依次随机的插入到`总表`中剩下的空位中。按照先前的计算，应该能够正常填充完整整个`总表`。且所有志愿者池都没有剩余元素，`已分配人员学号的集合`的元素数量等于岗位需求总人数。

## 输入文件路径
- pipeline\02_scheduling_preparation\正式普通志愿者表.xlsx
- input\内部志愿者表.xlsx
- input\家属志愿者表.xlsx
- input\情侣志愿者表.xlsx
- input\直接委派名单.xlsx
- input\团体\
- pipeline\02_scheduling_preparation\小组信息表.xlsx
- pipeline\02_scheduling_preparation\绑定集合表.xlsx
- pipeline\02_scheduling_preparation\metadata.json
- pipeline\01_interview_results\统一面试打分表.xlsx

## 配置文件路径
config\config.yaml